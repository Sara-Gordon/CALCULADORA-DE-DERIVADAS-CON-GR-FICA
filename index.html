<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Derivadas por Primer Principio</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/algebrite/1.5.0/algebrite.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 40px;
      background-color: #fff0f5;
      color: #4b004b;
    }

    h1 {
      text-align: center;
      color: #d63384;
    }

    input[type="text"] {
      width: 300px;
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    button {
      background-color: #ff69b4;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      margin-left: 10px;
    }

    button:hover {
      background-color: #ff1493;
    }

    #result {
      margin-top: 30px;
      font-size: 18px;
      line-height: 1.8;
    }

    canvas {
      margin-top: 30px;
      border: 1px solid #ccc;
      background: white;
    }
  </style>
</head>
<body>
  <h1>üìò Derivadas por Primer Principio</h1>
  <p>Ingresa una funci√≥n (usa por ejemplo: <i>x2, 1/x, sin(x), ln(x), raiz(x), ex</i>):</p>
  <input type="text" id="funcion" placeholder="Ej: x2 + 3x" />
  <button onclick="resolver()">Resolver</button>

  <div id="result"></div>
  <canvas id="grafico" width="500" height="300"></canvas>

  <script>
    function resolver() {
      const funcionInput = document.getElementById("funcion").value.trim();
      const resultDiv = document.getElementById("result");

      try {
        let funcionStr = funcionInput
          .replace(/(\d)([a-zA-Z])/g, "$1*$2")
          .replace(/x(\d)/g, "x*$1")
          .replace(/(\d+)x/g, "$1*x")
          .replace(/raiz\(([^)]+)\)/g, "sqrt($1)")
          .replace(/ln/g, "log")
          .replace(/ex/g, "e^x");

        const f_xh = Algebrite.run("simplify(subst(x+h, x, " + funcionStr + "))");
        const f_x = Algebrite.run("simplify(" + funcionStr + ")");
        const resta = Algebrite.run("simplify(" + f_xh + " - (" + f_x + "))");
        const fraccion = Algebrite.run("simplify( (" + resta + ") / h )");
        const derivada = Algebrite.run("simplify( subst(0, h, " + fraccion + ") )");

        let pasos = "";

        pasos += "<b>1Ô∏è‚É£ Definici√≥n de la derivada:</b><br>\\[ f'(x) = \\lim_{h \\to 0} \\frac{f(x+h) - f(x)}{h} \\]<br><br>";
        pasos += `<b>2Ô∏è‚É£ Funci√≥n dada:</b><br>\\[ f(x) = ${Algebrite.run("printlatex(" + funcionStr + ")")} \\]<br><br>`;
        pasos += `<b>3Ô∏è‚É£ Sustituci√≥n:</b><br>\\[ f(x+h) = ${Algebrite.run("printlatex(" + f_xh + ")")} \\]<br><br>`;
        pasos += `<b>4Ô∏è‚É£ Resta:</b><br>\\[ f(x+h) - f(x) = ${Algebrite.run("printlatex(" + resta + ")")} \\]<br><br>`;
        pasos += `<b>5Ô∏è‚É£ Fracci√≥n:</b><br>\\[ \\frac{${Algebrite.run("printlatex(" + resta + ")")}}{h} \\]<br><br>`;
        pasos += `<b>6Ô∏è‚É£ Simplificamos:</b><br>\\[ ${Algebrite.run("printlatex(" + fraccion + ")")} \\]<br><br>`;
        pasos += `<b>7Ô∏è‚É£ L√≠mite cuando h ‚Üí 0:</b><br>\\[ \\lim_{h \\to 0} ${Algebrite.run("printlatex(" + fraccion + ")")} = ${Algebrite.run("printlatex(" + derivada + ")")} \\]<br><br>`;
        pasos += `<b>8Ô∏è‚É£ Conclusi√≥n:</b><br>\\[ f'(x) = ${Algebrite.run("printlatex(" + derivada + ")")} \\]`;

        resultDiv.innerHTML = pasos;
        MathJax.typeset();

        graficar(funcionStr);
      } catch (error) {
        resultDiv.innerHTML = `<p style="color:red;">‚ö†Ô∏è No se pudo derivar la funci√≥n.<br>Revisa la sintaxis o funciones usadas.</p>`;
      }
    }

    function graficar(fx) {
      try {
        const canvas = document.getElementById("grafico");
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const evaluar = x => {
          try {
            return Algebrite.run(`float(subst(x, ${x}, ${fx}))`);
          } catch {
            return NaN;
          }
        };

        const w = canvas.width;
        const h = canvas.height;
        const escalaX = 20;
        const escalaY = 20;
        const centroX = w / 2;
        const centroY = h / 2;

        // Ejes
        ctx.strokeStyle = "#ccc";
        ctx.beginPath();
        ctx.moveTo(0, centroY);
        ctx.lineTo(w, centroY);
        ctx.moveTo(centroX, 0);
        ctx.lineTo(centroX, h);
        ctx.stroke();

        // Funci√≥n
        ctx.beginPath();
        ctx.strokeStyle = "#d63384";
        for (let px = 0; px < w; px++) {
          const x = (px - centroX) / escalaX;
          const y = evaluar(x);
          if (!isNaN(y)) {
            const py = centroY - y * escalaY;
            if (px === 0) {
              ctx.moveTo(px, py);
            } else {
              ctx.lineTo(px, py);
            }
          }
        }
        ctx.stroke();
      } catch (e) {
        console.error("Error al graficar:", e);
      }
    }
  </script>
</body>
</html>
